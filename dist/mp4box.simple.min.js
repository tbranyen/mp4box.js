/*! mp4box 13-09-2018 */

var Log=console;Log.setLogLevel=function(a){};var MP4BoxStream=function(a){if(!(a instanceof ArrayBuffer))throw"Needs an array buffer";this.buffer=a,this.dataview=new DataView(a),this.position=0};MP4BoxStream.prototype.getPosition=function(){return this.position},MP4BoxStream.prototype.getEndPosition=function(){return this.buffer.byteLength},MP4BoxStream.prototype.getLength=function(){return this.buffer.byteLength},MP4BoxStream.prototype.seek=function(a){var b=Math.max(0,Math.min(this.buffer.byteLength,a));return this.position=isNaN(b)||!isFinite(b)?0:b,!0},MP4BoxStream.prototype.isEos=function(){return this.getPosition()>=this.getEndPosition()},MP4BoxStream.prototype.readAnyInt=function(a,b){var c=0;if(this.position+a<=this.buffer.byteLength){switch(a){case 1:c=b?this.dataview.getInt8(this.position):this.dataview.getUint8(this.position);break;case 2:c=b?this.dataview.getInt16(this.position):this.dataview.getUint16(this.position);break;case 3:if(b)throw"No method for reading signed 24 bits values";c=this.dataview.getUint8(this.position)<<16,c|=this.dataview.getUint8(this.position)<<8,c|=this.dataview.getUint8(this.position);break;case 4:c=b?this.dataview.getInt32(this.position):this.dataview.getUint32(this.position);break;case 8:if(b)throw"No method for reading signed 64 bits values";c=this.dataview.getUint32(this.position)<<32,c|=this.dataview.getUint32(this.position);break;default:throw"readInt method not implemented for size: "+a}return this.position+=a,c}throw"Not enough bytes in buffer"},MP4BoxStream.prototype.readUint8=function(){return this.readAnyInt(1,!1)},MP4BoxStream.prototype.readUint16=function(){return this.readAnyInt(2,!1)},MP4BoxStream.prototype.readUint24=function(){return this.readAnyInt(3,!1)},MP4BoxStream.prototype.readUint32=function(){return this.readAnyInt(4,!1)},MP4BoxStream.prototype.readUint64=function(){return this.readAnyInt(8,!1)},MP4BoxStream.prototype.readString=function(a){if(this.position+a<=this.buffer.byteLength){for(var b="",c=0;c<a;c++)b+=String.fromCharCode(this.readUint8());return b}throw"Not enough bytes in buffer"},MP4BoxStream.prototype.readCString=function(){for(var a=[];;){var b=this.readUint8();if(0===b)break;a.push(b)}return String.fromCharCode.apply(null,a)},MP4BoxStream.prototype.readInt8=function(){return this.readAnyInt(1,!0)},MP4BoxStream.prototype.readInt16=function(){return this.readAnyInt(2,!0)},MP4BoxStream.prototype.readInt32=function(){return this.readAnyInt(4,!0)},MP4BoxStream.prototype.readUint8Array=function(a){for(var b=new Uint8Array(a),c=0;c<a;c++)b[c]=this.readUint8();return b},MP4BoxStream.prototype.readInt16Array=function(a){for(var b=new Int16Array(a),c=0;c<a;c++)b[c]=this.readUint16();return b},MP4BoxStream.prototype.readUint32Array=function(a){for(var b=new Uint32Array(a),c=0;c<a;c++)b[c]=this.readUint32();return b},MP4BoxStream.prototype.readInt32Array=function(a){for(var b=new Int32Array(a),c=0;c<a;c++)b[c]=this.readInt32();return b},"undefined"!=typeof exports&&(exports.MP4BoxStream=MP4BoxStream);var BoxParser={ERR_INVALID_DATA:-1,ERR_NOT_ENOUGH_DATA:0,OK:1,BASIC_BOXES:["mdat","idat","free","skip","meco","strk"],FULL_BOXES:["hmhd","nmhd","iods","xml ","bxml","ipro","mere"],CONTAINER_BOXES:[["moov",["trak","pssh"]],["trak"],["edts"],["mdia"],["minf"],["dinf"],["stbl",["sgpd","sbgp"]],["mvex",["trex"]],["moof",["traf"]],["traf",["trun","sgpd","sbgp"]],["vttc"],["tref"],["iref"],["mfra",["tfra"]],["meco"],["hnti"],["hinf"],["strk"],["strd"],["sinf"],["rinf"],["schi"],["trgr"],["udta",["kind"]],["iprp",["ipma"]],["ipco"]],boxCodes:[],fullBoxCodes:[],containerBoxCodes:[],sampleEntryCodes:{},sampleGroupEntryCodes:[],trackGroupTypes:[],UUIDBoxes:{},UUIDs:[],initialize:function(){BoxParser.FullBox.prototype=new BoxParser.Box,BoxParser.ContainerBox.prototype=new BoxParser.Box,BoxParser.SampleEntry.prototype=new BoxParser.Box,BoxParser.TrackGroupTypeBox.prototype=new BoxParser.FullBox,BoxParser.BASIC_BOXES.forEach(function(a){BoxParser.createBoxCtor(a)}),BoxParser.FULL_BOXES.forEach(function(a){BoxParser.createFullBoxCtor(a)}),BoxParser.CONTAINER_BOXES.forEach(function(a){BoxParser.createContainerBoxCtor(a[0],null,a[1])})},Box:function(a,b,c){this.type=a,this.size=b,this.uuid=c},FullBox:function(a,b,c){BoxParser.Box.call(this,a,b,c),this.flags=0,this.version=0},ContainerBox:function(a,b,c){BoxParser.Box.call(this,a,b,c),this.boxes=[]},SampleEntry:function(a,b,c,d){BoxParser.ContainerBox.call(this,a,b),this.hdr_size=c,this.start=d},SampleGroupEntry:function(a){this.grouping_type=a},TrackGroupTypeBox:function(a,b){BoxParser.FullBox.call(this,a,b)},createBoxCtor:function(a,b){BoxParser.boxCodes.push(a),BoxParser[a+"Box"]=function(b){BoxParser.Box.call(this,a,b)},BoxParser[a+"Box"].prototype=new BoxParser.Box,b&&(BoxParser[a+"Box"].prototype.parse=b)},createFullBoxCtor:function(a,b){BoxParser[a+"Box"]=function(b){BoxParser.FullBox.call(this,a,b)},BoxParser[a+"Box"].prototype=new BoxParser.FullBox,BoxParser[a+"Box"].prototype.parse=function(a){this.parseFullHeader(a),b&&b.call(this,a)}},addSubBoxArrays:function(a){if(a){this.subBoxNames=a;for(var b=a.length,c=0;c<b;c++)this[a[c]+"s"]=[]}},createContainerBoxCtor:function(a,b,c){BoxParser[a+"Box"]=function(b){BoxParser.ContainerBox.call(this,a,b),BoxParser.addSubBoxArrays.call(this,c)},BoxParser[a+"Box"].prototype=new BoxParser.ContainerBox,b&&(BoxParser[a+"Box"].prototype.parse=b)},createMediaSampleEntryCtor:function(a,b,c){BoxParser.sampleEntryCodes[a]=[],BoxParser[a+"SampleEntry"]=function(a,b){BoxParser.SampleEntry.call(this,a,b),BoxParser.addSubBoxArrays.call(this,c)},BoxParser[a+"SampleEntry"].prototype=new BoxParser.SampleEntry,b&&(BoxParser[a+"SampleEntry"].prototype.parse=b)},createSampleEntryCtor:function(a,b,c,d){BoxParser.sampleEntryCodes[a].push(b),BoxParser[b+"SampleEntry"]=function(c){BoxParser[a+"SampleEntry"].call(this,b,c),BoxParser.addSubBoxArrays.call(this,d)},BoxParser[b+"SampleEntry"].prototype=new BoxParser[a+"SampleEntry"],c&&(BoxParser[b+"SampleEntry"].prototype.parse=c)},createEncryptedSampleEntryCtor:function(a,b,c){BoxParser.createSampleEntryCtor.call(this,a,b,c,["sinf"])},createSampleGroupCtor:function(a,b){BoxParser[a+"SampleGroupEntry"]=function(b){BoxParser.SampleGroupEntry.call(this,a,b)},BoxParser[a+"SampleGroupEntry"].prototype=new BoxParser.SampleGroupEntry,b&&(BoxParser[a+"SampleGroupEntry"].prototype.parse=b)},createTrackGroupCtor:function(a,b){BoxParser[a+"TrackGroupTypeBox"]=function(b){BoxParser.TrackGroupTypeBox.call(this,a,b)},BoxParser[a+"TrackGroupTypeBox"].prototype=new BoxParser.TrackGroupTypeBox,b&&(BoxParser[a+"TrackGroupTypeBox"].prototype.parse=b)},createUUIDBox:function(a,b,c,d){BoxParser.UUIDBoxes[a]=function(d){b?BoxParser.FullBox.call(this,"uuid",d,a):c?BoxParser.ContainerBox.call(this,"uuid",d,a):BoxParser.Box.call(this,"uuid",d,a)},BoxParser.UUIDBoxes[a].prototype=b?new BoxParser.FullBox:c?new BoxParser.ContainerBox:new BoxParser.Box,d&&(BoxParser.UUIDBoxes[a].prototype.parse=b?function(a){this.parseFullHeader(a),d&&d.call(this,a)}:d)}};BoxParser.initialize(),BoxParser.TKHD_FLAG_ENABLED=1,BoxParser.TKHD_FLAG_IN_MOVIE=2,BoxParser.TKHD_FLAG_IN_PREVIEW=4,BoxParser.TFHD_FLAG_BASE_DATA_OFFSET=1,BoxParser.TFHD_FLAG_SAMPLE_DESC=2,BoxParser.TFHD_FLAG_SAMPLE_DUR=8,BoxParser.TFHD_FLAG_SAMPLE_SIZE=16,BoxParser.TFHD_FLAG_SAMPLE_FLAGS=32,BoxParser.TFHD_FLAG_DUR_EMPTY=65536,BoxParser.TFHD_FLAG_DEFAULT_BASE_IS_MOOF=131072,BoxParser.TRUN_FLAGS_DATA_OFFSET=1,BoxParser.TRUN_FLAGS_FIRST_FLAG=4,BoxParser.TRUN_FLAGS_DURATION=256,BoxParser.TRUN_FLAGS_SIZE=512,BoxParser.TRUN_FLAGS_FLAGS=1024,BoxParser.TRUN_FLAGS_CTS_OFFSET=2048,BoxParser.Box.prototype.add=function(a){return this.addBox(new BoxParser[a+"Box"])},BoxParser.Box.prototype.addBox=function(a){return this.boxes.push(a),this[a.type+"s"]?this[a.type+"s"].push(a):this[a.type]=a,a},BoxParser.Box.prototype.set=function(a,b){return this[a]=b,this},BoxParser.Box.prototype.addEntry=function(a,b){var c=b||"entries";return this[c]||(this[c]=[]),this[c].push(a),this},"undefined"!=typeof exports&&(exports.BoxParser=BoxParser),BoxParser.parseUUID=function(a){return BoxParser.parseHex16(a)},BoxParser.parseHex16=function(a){for(var b="",c=0;c<16;c++){var d=a.readUint8().toString(16);b+=1===d.length?"0"+d:d}return b},BoxParser.parseOneBox=function(a,b,c){var d,e,f,g=a.getPosition(),h=0;if(a.getEndPosition()-g<8)return Log.debug("BoxParser","Not enough data in stream to parse the type and size of the box"),{code:BoxParser.ERR_NOT_ENOUGH_DATA};if(c&&c<8)return Log.debug("BoxParser","Not enough bytes left in the parent box to parse a new box"),{code:BoxParser.ERR_NOT_ENOUGH_DATA};var i=a.readUint32(),j=a.readString(4),k=j;if(Log.debug("BoxParser","Found box of type '"+j+"' and size "+i+" at position "+g),h=8,"uuid"==j){if(a.getEndPosition()-a.getPosition()<16||c-h<16)return a.seek(g),Log.debug("BoxParser","Not enough bytes left in the parent box to parse a UUID box"),{code:BoxParser.ERR_NOT_ENOUGH_DATA};f=BoxParser.parseUUID(a),h+=16,k=f}if(1==i){if(a.getEndPosition()-a.getPosition()<8||c&&c-h<8)return a.seek(g),Log.warn("BoxParser",'Not enough data in stream to parse the extended size of the "'+j+'" box'),{code:BoxParser.ERR_NOT_ENOUGH_DATA};i=a.readUint64(),h+=8}else if(0===i)if(c)i=c;else if("mdat"!==j)return Log.error("BoxParser","Unlimited box size not supported for type: '"+j+"'"),d=new BoxParser.Box(j,i),{code:BoxParser.OK,box:d,size:d.size};return i<h?(Log.error("BoxParser","Box of type "+j+" has an invalid size "+i+" (too small to be a box)"),{code:BoxParser.ERR_NOT_ENOUGH_DATA,type:j,size:i,hdr_size:h,start:g}):c&&i>c?(Log.error("BoxParser","Box of type '"+j+"' has a size "+i+" greater than its container size "+c),{code:BoxParser.ERR_NOT_ENOUGH_DATA,type:j,size:i,hdr_size:h,start:g}):g+i>a.getEndPosition()?(a.seek(g),Log.info("BoxParser","Not enough data in stream to parse the entire '"+j+"' box"),{code:BoxParser.ERR_NOT_ENOUGH_DATA,type:j,size:i,hdr_size:h,start:g}):b?{code:BoxParser.OK,type:j,size:i,hdr_size:h,start:g}:(BoxParser[j+"Box"]?d=new BoxParser[j+"Box"](i):"uuid"!==j?(Log.warn("BoxParser","Unknown box type: '"+j+"'"),d=new BoxParser.Box(j,i),d.has_unparsed_data=!0):BoxParser.UUIDBoxes[f]?d=new BoxParser.UUIDBoxes[f](i):(Log.warn("BoxParser","Unknown uuid type: '"+f+"'"),d=new BoxParser.Box(j,i),d.uuid=f,d.has_unparsed_data=!0),d.hdr_size=h,d.start=g,d.write===BoxParser.Box.prototype.write&&"mdat"!==d.type&&(Log.info("BoxParser","'"+k+"' box writing not yet implemented, keeping unparsed data in memory for later write"),d.parseDataAndRewind(a)),d.parse(a),e=a.getPosition()-(d.start+d.size),e<0?(Log.warn("BoxParser","Parsing of box '"+k+"' did not read the entire indicated box data size (missing "+-e+" bytes), seeking forward"),a.seek(d.start+d.size)):e>0&&(Log.error("BoxParser","Parsing of box '"+k+"' read "+e+" more bytes than the indicated box data size, seeking backwards"),a.seek(d.start+d.size)),{code:BoxParser.OK,box:d,size:d.size})},BoxParser.Box.prototype.parse=function(a){"mdat"!=this.type?this.data=a.readUint8Array(this.size-this.hdr_size):0===this.size?a.seek(a.getEndPosition()):a.seek(this.start+this.size)},BoxParser.Box.prototype.parseDataAndRewind=function(a){this.data=a.readUint8Array(this.size-this.hdr_size),a.position-=this.size-this.hdr_size},BoxParser.FullBox.prototype.parseDataAndRewind=function(a){this.parseFullHeader(a),this.data=a.readUint8Array(this.size-this.hdr_size),this.hdr_size-=4,a.position-=this.size-this.hdr_size},BoxParser.FullBox.prototype.parseFullHeader=function(a){this.version=a.readUint8(),this.flags=a.readUint24(),this.hdr_size+=4},BoxParser.FullBox.prototype.parse=function(a){this.parseFullHeader(a),this.data=a.readUint8Array(this.size-this.hdr_size)},BoxParser.ContainerBox.prototype.parse=function(a){for(var b,c;a.getPosition()<this.start+this.size;){if(b=BoxParser.parseOneBox(a,!1,this.size-(a.getPosition()-this.start)),b.code!==BoxParser.OK)return;if(c=b.box,this.boxes.push(c),this.subBoxNames&&-1!=this.subBoxNames.indexOf(c.type))this[this.subBoxNames[this.subBoxNames.indexOf(c.type)]+"s"].push(c);else{var d="uuid"!==c.type?c.type:c.uuid;this[d]?Log.warn("Box of type "+d+" already stored in field of this type"):this[d]=c}}},BoxParser.Box.prototype.parseLanguage=function(a){this.language=a.readUint16();var b=[];b[0]=this.language>>10&31,b[1]=this.language>>5&31,b[2]=31&this.language,this.languageString=String.fromCharCode(b[0]+96,b[1]+96,b[2]+96)},BoxParser.createFullBoxCtor("emsg",function(a){this.scheme_id_uri=a.readCString(),this.value=a.readCString(),this.timescale=a.readUint32(),this.presentation_time_delta=a.readUint32(),this.event_duration=a.readUint32(),this.id=a.readUint32();var b=this.size-this.hdr_size-(16+(this.scheme_id_uri.length+1)+(this.value.length+1));this.message_data=a.readUint8Array(b)}),BoxParser.createBoxCtor("styp",function(a){BoxParser.ftypBox.prototype.parse.call(this,a)}),BoxParser.createBoxCtor("ftyp",function(a){var b=this.size-this.hdr_size;this.major_brand=a.readString(4),this.minor_version=a.readUint32(),b-=8,this.compatible_brands=[];for(var c=0;b>=4;)this.compatible_brands[c]=a.readString(4),b-=4,c++}),BoxParser.createFullBoxCtor("mdhd",function(a){1==this.version?(this.creation_time=a.readUint64(),this.modification_time=a.readUint64(),this.timescale=a.readUint32(),this.duration=a.readUint64()):(this.creation_time=a.readUint32(),this.modification_time=a.readUint32(),this.timescale=a.readUint32(),this.duration=a.readUint32()),this.parseLanguage(a),a.readUint16()}),BoxParser.createFullBoxCtor("mfhd",function(a){this.sequence_number=a.readUint32()}),BoxParser.createFullBoxCtor("mvhd",function(a){1==this.version?(this.creation_time=a.readUint64(),this.modification_time=a.readUint64(),this.timescale=a.readUint32(),this.duration=a.readUint64()):(this.creation_time=a.readUint32(),this.modification_time=a.readUint32(),this.timescale=a.readUint32(),this.duration=a.readUint32()),this.rate=a.readUint32(),this.volume=a.readUint16()>>8,a.readUint16(),a.readUint32Array(2),this.matrix=a.readUint32Array(9),a.readUint32Array(6),this.next_track_id=a.readUint32()}),BoxParser.createFullBoxCtor("sidx",function(a){this.reference_ID=a.readUint32(),this.timescale=a.readUint32(),0===this.version?(this.earliest_presentation_time=a.readUint32(),this.first_offset=a.readUint32()):(this.earliest_presentation_time=a.readUint64(),this.first_offset=a.readUint64()),a.readUint16(),this.references=[];for(var b=a.readUint16(),c=0;c<b;c++){var d={};this.references.push(d);var e=a.readUint32();d.reference_type=e>>31&1,d.referenced_size=2147483647&e,d.subsegment_duration=a.readUint32(),e=a.readUint32(),d.starts_with_SAP=e>>31&1,d.SAP_type=e>>28&7,d.SAP_delta_time=268435455&e}}),BoxParser.createFullBoxCtor("ssix",function(a){this.subsegments=[];for(var b=a.readUint32(),c=0;c<b;c++){var d={};this.subsegments.push(d),d.ranges=[];for(var e=a.readUint32(),f=0;f<e;f++){var g={};d.ranges.push(g),g.level=a.readUint8(),g.range_size=a.readUint24()}}}),BoxParser.createFullBoxCtor("tkhd",function(a){1==this.version?(this.creation_time=a.readUint64(),this.modification_time=a.readUint64(),this.track_id=a.readUint32(),a.readUint32(),this.duration=a.readUint64()):(this.creation_time=a.readUint32(),this.modification_time=a.readUint32(),this.track_id=a.readUint32(),a.readUint32(),this.duration=a.readUint32()),a.readUint32Array(2),this.layer=a.readInt16(),this.alternate_group=a.readInt16(),this.volume=a.readInt16()>>8,a.readUint16(),this.matrix=a.readInt32Array(9),this.width=a.readUint32(),this.height=a.readUint32()}),BoxParser.createFullBoxCtor("tfhd",function(a){var b=0;this.track_id=a.readUint32(),this.size-this.hdr_size>b&&this.flags&BoxParser.TFHD_FLAG_BASE_DATA_OFFSET?(this.base_data_offset=a.readUint64(),b+=8):this.base_data_offset=0,this.size-this.hdr_size>b&&this.flags&BoxParser.TFHD_FLAG_SAMPLE_DESC?(this.default_sample_description_index=a.readUint32(),b+=4):this.default_sample_description_index=0,this.size-this.hdr_size>b&&this.flags&BoxParser.TFHD_FLAG_SAMPLE_DUR?(this.default_sample_duration=a.readUint32(),b+=4):this.default_sample_duration=0,this.size-this.hdr_size>b&&this.flags&BoxParser.TFHD_FLAG_SAMPLE_SIZE?(this.default_sample_size=a.readUint32(),b+=4):this.default_sample_size=0,this.size-this.hdr_size>b&&this.flags&BoxParser.TFHD_FLAG_SAMPLE_FLAGS?(this.default_sample_flags=a.readUint32(),b+=4):this.default_sample_flags=0}),BoxParser.createFullBoxCtor("tfdt",function(a){1==this.version?this.baseMediaDecodeTime=a.readUint64():this.baseMediaDecodeTime=a.readUint32()}),BoxParser.createFullBoxCtor("trun",function(a){var b=0;if(this.sample_count=a.readUint32(),b+=4,this.size-this.hdr_size>b&&this.flags&BoxParser.TRUN_FLAGS_DATA_OFFSET?(this.data_offset=a.readInt32(),b+=4):this.data_offset=0,this.size-this.hdr_size>b&&this.flags&BoxParser.TRUN_FLAGS_FIRST_FLAG?(this.first_sample_flags=a.readUint32(),b+=4):this.first_sample_flags=0,this.sample_duration=[],this.sample_size=[],this.sample_flags=[],this.sample_composition_time_offset=[],this.size-this.hdr_size>b)for(var c=0;c<this.sample_count;c++)this.flags&BoxParser.TRUN_FLAGS_DURATION&&(this.sample_duration[c]=a.readUint32()),this.flags&BoxParser.TRUN_FLAGS_SIZE&&(this.sample_size[c]=a.readUint32()),this.flags&BoxParser.TRUN_FLAGS_FLAGS&&(this.sample_flags[c]=a.readUint32()),this.flags&BoxParser.TRUN_FLAGS_CTS_OFFSET&&(0===this.version?this.sample_composition_time_offset[c]=a.readUint32():this.sample_composition_time_offset[c]=a.readInt32())});var ISOFile=function(a){this.stream=a||new MultiBufferStream,this.boxes=[],this.mdats=[],this.moofs=[],this.isProgressive=!1,this.moovStartFound=!1,this.onMoovStart=null,this.moovStartSent=!1,this.onReady=null,this.readySent=!1,this.onSegment=null,this.onSamples=null,this.onError=null,this.sampleListBuilt=!1,this.fragmentedTracks=[],this.extractedTracks=[],this.isFragmentationInitialized=!1,this.sampleProcessingStarted=!1,this.nextMoofNumber=0,this.itemListBuilt=!1};ISOFile.prototype.setSegmentOptions=function(a,b,c){var d=this.getTrackById(a);if(d){var e={};this.fragmentedTracks.push(e),e.id=a,e.user=b,e.trak=d,d.nextSample=0,e.segmentStream=null,e.nb_samples=1e3,e.rapAlignement=!0,c&&(c.nbSamples&&(e.nb_samples=c.nbSamples),c.rapAlignement&&(e.rapAlignement=c.rapAlignement))}},ISOFile.prototype.unsetSegmentOptions=function(a){for(var b=-1,c=0;c<this.fragmentedTracks.length;c++){this.fragmentedTracks[c].id==a&&(b=c)}b>-1&&this.fragmentedTracks.splice(b,1)},ISOFile.prototype.setExtractionOptions=function(a,b,c){var d=this.getTrackById(a);if(d){var e={};this.extractedTracks.push(e),e.id=a,e.user=b,e.trak=d,d.nextSample=0,e.nb_samples=1e3,e.samples=[],c&&c.nbSamples&&(e.nb_samples=c.nbSamples)}},ISOFile.prototype.unsetExtractionOptions=function(a){for(var b=-1,c=0;c<this.extractedTracks.length;c++){this.extractedTracks[c].id==a&&(b=c)}b>-1&&this.extractedTracks.splice(b,1)},ISOFile.prototype.parse=function(){var a,b;if(!this.restoreParsePosition||this.restoreParsePosition())for(;;){if(this.hasIncompleteMdat&&this.hasIncompleteMdat()){if(this.processIncompleteMdat())continue;return}if(this.saveParsePosition&&this.saveParsePosition(),a=BoxParser.parseOneBox(this.stream,!1),a.code===BoxParser.ERR_NOT_ENOUGH_DATA){if(this.processIncompleteBox){if(this.processIncompleteBox(a))continue;return}return}var c;switch(b=a.box,c="uuid"!==b.type?b.type:b.uuid,this.boxes.push(b),c){case"mdat":this.mdats.push(b);break;case"moof":this.moofs.push(b);break;case"moov":this.moovStartFound=!0,0===this.mdats.length&&(this.isProgressive=!0);default:void 0!==this[c]&&Log.warn("ISOFile","Duplicate Box of type: "+c+", overriding previous occurrence"),this[c]=b}this.updateUsedBytes&&this.updateUsedBytes(b,a)}},ISOFile.prototype.checkBuffer=function(a){if(null===a||void 0===a)throw"Buffer must be defined and non empty";if(void 0===a.fileStart)throw"Buffer must have a fileStart property";return 0===a.byteLength?(Log.warn("ISOFile","Ignoring empty buffer (fileStart: "+a.fileStart+")"),this.stream.logBufferLevel(),!1):(Log.info("ISOFile","Processing buffer (fileStart: "+a.fileStart+")"),a.usedBytes=0,this.stream.insertBuffer(a),this.stream.logBufferLevel(),!!this.stream.initialized()||(Log.warn("ISOFile","Not ready to start parsing"),!1))},ISOFile.prototype.appendBuffer=function(a,b){var c;if(this.checkBuffer(a))return this.parse(),this.moovStartFound&&!this.moovStartSent&&(this.moovStartSent=!0,this.onMoovStart&&this.onMoovStart()),this.moov?(this.sampleListBuilt||(this.buildSampleLists(),this.sampleListBuilt=!0),this.updateSampleLists(),this.onReady&&!this.readySent&&(this.readySent=!0,this.onReady(this.getInfo())),this.processSamples(b),this.nextSeekPosition?(c=this.nextSeekPosition,this.nextSeekPosition=void 0):c=this.nextParsePosition,this.stream.getEndFilePositionAfter&&(c=this.stream.getEndFilePositionAfter(c))):c=this.nextParsePosition?this.nextParsePosition:0,this.meta&&(this.flattenItemInfo&&!this.itemListBuilt&&(this.flattenItemInfo(),this.itemListBuilt=!0),this.processItems&&this.processItems(this.onItem)),this.stream.cleanBuffers&&(Log.info("ISOFile","Done processing buffer (fileStart: "+a.fileStart+") - next buffer to fetch should have a fileStart position of "+c),this.stream.logBufferLevel(),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0),Log.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize())),c},ISOFile.prototype.getInfo=function(){var a,b,c,d,e,f={},g=new Date(4,0,1,0,0,0,0).getTime();if(this.moov)for(f.hasMoov=!0,f.duration=this.moov.mvhd.duration,f.timescale=this.moov.mvhd.timescale,f.isFragmented=null!=this.moov.mvex,f.isFragmented&&this.moov.mvex.mehd&&(f.fragment_duration=this.moov.mvex.mehd.fragment_duration),f.isProgressive=this.isProgressive,f.hasIOD=null!=this.moov.iods,f.brands=[],f.brands.push(this.ftyp.major_brand),f.brands=f.brands.concat(this.ftyp.compatible_brands),f.created=new Date(g+1e3*this.moov.mvhd.creation_time),f.modified=new Date(g+1e3*this.moov.mvhd.modification_time),f.tracks=[],f.audioTracks=[],f.videoTracks=[],f.subtitleTracks=[],f.metadataTracks=[],f.hintTracks=[],f.otherTracks=[],a=0;a<this.moov.traks.length;a++){if(c=this.moov.traks[a],e=c.mdia.minf.stbl.stsd.entries[0],d={},f.tracks.push(d),d.id=c.tkhd.track_id,d.name=c.mdia.hdlr.name,d.references=[],c.tref)for(b=0;b<c.tref.boxes.length;b++)ref={},d.references.push(ref),ref.type=c.tref.boxes[b].type,ref.track_ids=c.tref.boxes[b].track_ids;c.edts&&(d.edits=c.edts.elst.entries),d.created=new Date(g+1e3*c.tkhd.creation_time),d.modified=new Date(g+1e3*c.tkhd.modification_time),d.movie_duration=c.tkhd.duration,d.movie_timescale=f.timescale,d.layer=c.tkhd.layer,d.alternate_group=c.tkhd.alternate_group,d.volume=c.tkhd.volume,d.matrix=c.tkhd.matrix,d.track_width=c.tkhd.width/65536,d.track_height=c.tkhd.height/65536,d.timescale=c.mdia.mdhd.timescale,d.cts_shift=c.mdia.minf.stbl.cslg,d.duration=c.mdia.mdhd.duration,d.samples_duration=c.samples_duration,d.codec=e.getCodec(),d.kind=c.udta&&c.udta.kinds.length?c.udta.kinds[0]:{schemeURI:"",value:""},d.language=c.mdia.elng?c.mdia.elng.extended_language:c.mdia.mdhd.languageString,d.nb_samples=c.samples.length,d.size=c.samples_size,d.bitrate=8*d.size*d.timescale/d.samples_duration,e.isAudio()?(d.type="audio",f.audioTracks.push(d),d.audio={},d.audio.sample_rate=e.getSampleRate(),d.audio.channel_count=e.getChannelCount(),d.audio.sample_size=e.getSampleSize()):e.isVideo()?(d.type="video",f.videoTracks.push(d),d.video={},d.video.width=e.getWidth(),d.video.height=e.getHeight()):e.isSubtitle()?(d.type="subtitles",f.subtitleTracks.push(d)):e.isHint()?(d.type="metadata",f.hintTracks.push(d)):e.isMetadata()?(d.type="metadata",f.metadataTracks.push(d)):(d.type="metadata",f.otherTracks.push(d))}else f.hasMoov=!1;for(f.mime="",f.videoTracks.length>0?f.mime+='video/mp4; codecs="':f.audioTracks.length>0?f.mime+='audio/mp4; codecs="':f.mime+='application/mp4; codecs="',a=0;a<f.tracks.length;a++)0!==a&&(f.mime+=","),f.mime+=f.tracks[a].codec;return f.mime+='"; profiles="',f.mime+=this.ftyp.compatible_brands.join(),f.mime+='"',f},ISOFile.prototype.processSamples=function(a){var b,c;if(this.sampleProcessingStarted){if(this.isFragmentationInitialized&&null!==this.onSegment)for(b=0;b<this.fragmentedTracks.length;b++){var d=this.fragmentedTracks[b];for(c=d.trak;c.nextSample<c.samples.length&&this.sampleProcessingStarted;){Log.debug("ISOFile","Creating media fragment on track #"+d.id+" for sample "+c.nextSample);var e=this.createFragment(d.id,c.nextSample,d.segmentStream);if(!e)break;if(d.segmentStream=e,(++c.nextSample%d.nb_samples==0||a&&c.nextSample>=c.samples.length)&&(Log.info("ISOFile","Sending fragmented data on track #"+d.id+" for samples ["+Math.max(0,c.nextSample-d.nb_samples)+","+(c.nextSample-1)+"]"),Log.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize()),this.onSegment&&this.onSegment(d.id,d.user,d.segmentStream.buffer,c.nextSample,a&&c.nextSample>=c.samples.length),d.segmentStream=null,d!==this.fragmentedTracks[b]))break}}if(null!==this.onSamples)for(b=0;b<this.extractedTracks.length;b++){var f=this.extractedTracks[b];for(c=f.trak;c.nextSample<c.samples.length&&this.sampleProcessingStarted;){Log.debug("ISOFile","Exporting on track #"+f.id+" sample #"+c.nextSample);var g=this.getSample(c,c.nextSample);if(!g)break;if(c.nextSample++,f.samples.push(g),(c.nextSample%f.nb_samples==0||c.nextSample>=c.samples.length)&&(Log.debug("ISOFile","Sending samples on track #"+f.id+" for sample "+c.nextSample),this.onSamples&&this.onSamples(f.id,f.user,f.samples),f.samples=[],f!==this.extractedTracks[b]))break}}}},ISOFile.prototype.getBox=function(a){var b=this.getBoxes(a,!0);return b.length?b[0]:null},ISOFile.prototype.getBoxes=function(a,b){var c=[];return ISOFile._sweep.call(this,a,c,b),c},ISOFile._sweep=function(a,b,c){this.type&&this.type==a&&b.push(this);for(var d in this.boxes){if(b.length&&c)return;ISOFile._sweep.call(this.boxes[d],a,b,c)}},ISOFile.prototype.getTrackSamplesInfo=function(a){var b=this.getTrackById(a);return b?b.samples:void 0},ISOFile.prototype.getTrackSample=function(a,b){var c=this.getTrackById(a);return this.getSample(c,b)},ISOFile.prototype.releaseUsedSamples=function(a,b){var c=0,d=this.getTrackById(a);d.lastValidSample||(d.lastValidSample=0);for(var e=d.lastValidSample;e<b;e++)c+=this.releaseSample(d,e);Log.info("ISOFile","Track #"+a+" released samples up to "+b+" (released size: "+c+", remaining: "+this.samplesDataSize+")"),d.lastValidSample=b},ISOFile.prototype.start=function(){this.sampleProcessingStarted=!0,this.processSamples(!1)},ISOFile.prototype.stop=function(){this.sampleProcessingStarted=!1},ISOFile.prototype.flush=function(){Log.info("ISOFile","Flushing remaining samples"),this.updateSampleLists(),this.processSamples(!0),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0)},ISOFile.prototype.seekTrack=function(a,b,c){var d,e,f,g=1/0,h=0,i=0;if(0===c.samples.length)return Log.info("ISOFile","No sample in track, cannot seek! Using time "+Log.getDurationString(0,1)+" and offset: 0"),{offset:0,time:0};for(d=0;d<c.samples.length;d++){if(e=c.samples[d],0===d)i=0,f=e.timescale;else if(e.cts>a*e.timescale){i=d-1;break}b&&e.is_sync&&(h=d)}for(b&&(i=h),a=c.samples[i].cts,c.nextSample=i;c.samples[i].alreadyRead===c.samples[i].size;)i++;return g=c.samples[i].offset+c.samples[i].alreadyRead,Log.info("ISOFile","Seeking to "+(b?"RAP":"")+" sample #"+c.nextSample+" on track "+c.tkhd.track_id+", time "+Log.getDurationString(a,f)+" and offset: "+g),{offset:g,time:a/f}},ISOFile.prototype.seek=function(a,b){var c,d,e,f=this.moov,g={offset:1/0,time:1/0};if(this.moov){for(e=0;e<f.traks.length;e++)c=f.traks[e],d=this.seekTrack(a,b,c),d.offset<g.offset&&(g.offset=d.offset),d.time<g.time&&(g.time=d.time);return Log.info("ISOFile","Seeking at time "+Log.getDurationString(g.time,1)+" needs a buffer with a fileStart position of "+g.offset),g.offset===1/0?g={offset:this.nextParsePosition,time:0}:g.offset=this.stream.getEndFilePositionAfter(g.offset),Log.info("ISOFile","Adjusted seek position (after checking data already in buffer): "+g.offset),g}throw"Cannot seek: moov not received!"},"undefined"!=typeof exports&&(exports.ISOFile=ISOFile),BoxParser.Box.prototype.printHeader=function(a){this.size+=8,this.size>MAX_SIZE&&(this.size+=8),"uuid"===this.type&&(this.size+=16),a.log(a.indent+"size:"+this.size),a.log(a.indent+"type:"+this.type)},BoxParser.FullBox.prototype.printHeader=function(a){this.size+=4,BoxParser.Box.prototype.printHeader.call(this,a),a.log(a.indent+"version:"+this.version),a.log(a.indent+"flags:"+this.flags)},BoxParser.Box.prototype.print=function(a){this.printHeader(a)},BoxParser.ContainerBox.prototype.print=function(a){this.printHeader(a);for(var b=0;b<this.boxes.length;b++)if(this.boxes[b]){var c=a.indent;a.indent+=" ",this.boxes[b].print(a),a.indent=c}},ISOFile.prototype.print=function(a){a.indent="";for(var b=0;b<this.boxes.length;b++)this.boxes[b]&&this.boxes[b].print(a)},BoxParser.mvhdBox.prototype.print=function(a){BoxParser.FullBox.prototype.printHeader.call(this,a),a.log(a.indent+"creation_time: "+this.creation_time),a.log(a.indent+"modification_time: "+this.modification_time),a.log(a.indent+"timescale: "+this.timescale),a.log(a.indent+"duration: "+this.duration),a.log(a.indent+"rate: "+this.rate),a.log(a.indent+"volume: "+(this.volume>>8)),a.log(a.indent+"matrix: "+this.matrix.join(", ")),a.log(a.indent+"next_track_id: "+this.next_track_id)},BoxParser.tkhdBox.prototype.print=function(a){BoxParser.FullBox.prototype.printHeader.call(this,a),a.log(a.indent+"creation_time: "+this.creation_time),a.log(a.indent+"modification_time: "+this.modification_time),a.log(a.indent+"track_id: "+this.track_id),a.log(a.indent+"duration: "+this.duration),a.log(a.indent+"volume: "+(this.volume>>8)),a.log(a.indent+"matrix: "+this.matrix.join(", ")),a.log(a.indent+"layer: "+this.layer),a.log(a.indent+"alternate_group: "+this.alternate_group),a.log(a.indent+"width: "+this.width),a.log(a.indent+"height: "+this.height)};var MP4Box={};MP4Box.createFile=function(a,b){var c=void 0===a||a,d=new ISOFile(b);return d.discardMdatData=!c,d},"undefined"!=typeof exports&&(exports.createFile=MP4Box.createFile);
//# sourceMappingURL=mp4box.simple.min.js.map